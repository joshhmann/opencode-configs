#!/bin/bash

# Oh My OpenCode Mode Switcher
# Usage: omo-mode [free|balanced|performance]

CONFIG_DIR="$HOME/.config/opencode"
CURRENT_CONFIG="$CONFIG_DIR/oh-my-opencode.json"

# Source version utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/lib/version-utils.sh" ]; then
    source "$SCRIPT_DIR/lib/version-utils.sh"
elif [ -f "$CONFIG_DIR/lib/version-utils.sh" ]; then
    source "$CONFIG_DIR/lib/version-utils.sh"
fi

show_help() {
    echo "Oh My OpenCode Mode Switcher"
    echo ""
    echo "Usage: omo-mode [MODE]"
    echo ""
    echo "Modes:"
    echo "  free        - Use free models primarily (opencode/kimi-k2.5-free, glm-4.7-free)"
    echo "  balanced    - Uses kimi-for-coding k2p5 via subscription, falls back to antigravity"
    echo "  performance - Maximum quality with kimi-for-coding k2p5 as primary"
    echo "  list        - Show available modes and current status"
    echo "  check-update - Check for available updates"
    echo "  update      - Apply updates (asks for confirmation)"
    echo "  update --yes - Apply updates without confirmation"
    echo ""
    echo "Examples:"
    echo "  omo-mode free       # Switch to free/frugal mode"
    echo "  omo-mode performance # Switch to performance mode"
    echo "  omo-mode update      # Update configs (with confirmation)"
    echo "  omo-mode update --yes # Update configs (no confirmation)"
}

show_status() {
    echo "Current Oh My OpenCode Mode:"
    echo ""
    
    if [ -L "$CURRENT_CONFIG" ]; then
        target=$(readlink "$CURRENT_CONFIG")
        mode=$(basename "$target" .json | sed 's/oh-my-opencode-//')
        echo "  Active: $mode mode"
        echo "  File:   $target"
    else
        echo "  Active: custom (not a symlink)"
        echo "  File:   $CURRENT_CONFIG"
    fi
    echo ""
    echo "Available modes:"
    for config in "$CONFIG_DIR"/oh-my-opencode*.json; do
        if [ -f "$config" ]; then
            name=$(basename "$config" .json | sed 's/oh-my-opencode-//')
            if [ "$name" = "oh-my-opencode" ]; then
                name="balanced (default)"
            fi
            echo "  - $name"
        fi
    done
}

switch_mode() {
    mode=$1
    
    case "$mode" in
        free)
            target="oh-my-opencode-free.json"
            ;;
        balanced)
            target="oh-my-opencode-balanced.json"
            # If balanced doesn't exist, we'll use the original
            if [ ! -f "$CONFIG_DIR/$target" ]; then
                echo "Creating balanced mode from current config..."
                cp "$CURRENT_CONFIG" "$CONFIG_DIR/oh-my-opencode-balanced.json"
                target="oh-my-opencode-balanced.json"
            fi
            ;;
        performance)
            target="oh-my-opencode-performance.json"
            ;;
        *)
            echo "Error: Unknown mode '$mode'"
            echo ""
            show_help
            exit 1
            ;;
    esac
    
    if [ ! -f "$CONFIG_DIR/$target" ]; then
        echo "Error: Configuration file not found: $CONFIG_DIR/$target"
        exit 1
    fi
    
    # Backup current config if it's not a symlink
    if [ -f "$CURRENT_CONFIG" ] && [ ! -L "$CURRENT_CONFIG" ]; then
        backup="$CONFIG_DIR/oh-my-opencode-backup-$(date +%Y%m%d-%H%M%S).json"
        cp "$CURRENT_CONFIG" "$backup"
        echo "Backed up current config to: $backup"
    fi
    
    # Remove existing symlink or file
    rm -f "$CURRENT_CONFIG"
    
    # Create new symlink
    ln -s "$CONFIG_DIR/$target" "$CURRENT_CONFIG"
    
    echo ""
    echo "✓ Switched to $mode mode"
    echo "  Config: $CONFIG_DIR/$target"
    echo ""
    echo "Next time you start opencode, it will use the $mode configuration."
    echo "Restart any running opencode sessions to apply the changes."
}

check_update() {
    echo "Current Oh My OpenCode Mode:"
    echo ""
    
    # Get current mode from symlink
    local current_mode="unknown"
    local local_version="unknown"
    if [ -L "$CURRENT_CONFIG" ]; then
        local target=$(readlink "$CURRENT_CONFIG")
        current_mode=$(basename "$target" .json | sed 's/oh-my-opencode-//')
        if [ -f "$target" ] && command -v get_config_version &> /dev/null; then
            local_version=$(get_config_version "$target")
        fi
    fi
    
    echo "  Active: $current_mode"
    echo "  Local version: $local_version"
    
    # Get remote version
    local remote_version="unknown"
    local base_url="https://raw.githubusercontent.com/joshhmann/opencode-configs/main/configs"
    local temp_file=$(mktemp)
    
    if curl -fsSL -m 10 "$base_url/oh-my-opencode-${current_mode}.json" -o "$temp_file" 2>/dev/null; then
        if command -v get_config_version &> /dev/null; then
            remote_version=$(get_config_version "$temp_file")
        fi
    fi
    rm -f "$temp_file"
    
    echo "  Remote version: $remote_version"
    
    # Compare versions
    if [ "$local_version" != "unknown" ] && [ "$remote_version" != "unknown" ]; then
        if command -v version_compare &> /dev/null; then
            version_compare "$local_version" "$remote_version"
            case $? in
                0) echo "  Status: Up to date" ;;
                1) echo "  Status: Local is newer (development?)" ;;
                2) echo "  Status: Update available" ;;
            esac
        else
            if [ "$local_version" = "$remote_version" ]; then
                echo "  Status: Up to date"
            else
                echo "  Status: Version mismatch (local: $local_version, remote: $remote_version)"
            fi
        fi
    else
        echo "  Status: Could not determine update status"
    fi
}

# Download remote configs to temp directory
download_remote_configs() {
    local temp_dir="$1"
    local base_url="https://raw.githubusercontent.com/joshhmann/opencode-configs/main/configs"
    local configs="oh-my-opencode-free.json oh-my-opencode-balanced.json oh-my-opencode-performance.json oh-my-opencode-gemini-free.json oh-my-opencode-gemini-balanced.json oh-my-opencode-gemini-performance.json"

    for config in $configs; do
        if ! curl -fsSL -m 30 "$base_url/$config" -o "$temp_dir/$config" 2>/dev/null; then
            echo "ERROR: Failed to download $config" >&2
            return 1
        fi
    done
    return 0
}

# Validate downloaded configs
validate_configs() {
    local temp_dir="$1"
    local has_error=0

    for config in "$temp_dir"/*.json; do
        if [ -f "$config" ]; then
            local basename=$(basename "$config")

            # Validate JSON syntax
            if ! python3 -c "import json; json.load(open('$config'))" 2>/dev/null; then
                echo "ERROR: Invalid JSON in $basename" >&2
                has_error=1
                continue
            fi

            # Verify _version field exists
            if ! grep -q '"_version"' "$config"; then
                echo "ERROR: Missing _version in $basename" >&2
                has_error=1
                continue
            fi
        fi
    done

    return $has_error
}

# Perform update with user confirmation
perform_update() {
    local auto_confirm=false
    if [ "$1" = "--yes" ]; then
        auto_confirm=true
    fi

    echo "Checking for updates..."

    # Get current mode before update
    local current_mode="balanced"
    local local_version="unknown"
    if [ -L "$CURRENT_CONFIG" ]; then
        local target=$(readlink "$CURRENT_CONFIG")
        current_mode=$(basename "$target" .json | sed 's/oh-my-opencode-//')
        if [ -f "$target" ] && command -v get_config_version &> /dev/null; then
            local_version=$(get_config_version "$target")
        fi
    fi

    # Get remote version
    local remote_version="unknown"
    local base_url="https://raw.githubusercontent.com/joshhmann/opencode-configs/main/configs"
    local temp_file=$(mktemp)

    if curl -fsSL -m 10 "$base_url/oh-my-opencode-${current_mode}.json" -o "$temp_file" 2>/dev/null; then
        if command -v get_config_version &> /dev/null; then
            remote_version=$(get_config_version "$temp_file")
        fi
    fi
    rm -f "$temp_file"

    echo "Current mode: $current_mode"
    echo "Local version: $local_version"
    echo "Remote version: $remote_version"

    # Check if update needed
    if [ "$local_version" != "unknown" ] && [ "$remote_version" != "unknown" ]; then
        if command -v version_compare &> /dev/null; then
            version_compare "$local_version" "$remote_version"
            case $? in
                0)
                    echo "No updates available"
                    return 0
                    ;;
                1)
                    echo "Local version is newer (development?), no update needed"
                    return 0
                    ;;
                2)
                    echo "Update available: $local_version → $remote_version"
                    ;;
            esac
        else
            if [ "$local_version" = "$remote_version" ]; then
                echo "No updates available"
                return 0
            else
                echo "Version mismatch - checking remote..."
            fi
        fi
    else
        echo "Could not determine update status"
        if ! $auto_confirm; then
            read -p "Proceed anyway? [y/N] " confirm
            [[ "$confirm" =~ [yY] ]] || return 1
        fi
    fi

    if has_user_modifications; then
        local modified=$(detect_modified_configs)
        echo "WARNING: You have modified config files: $modified"
        if ! $auto_confirm; then
            read -p "Continue and overwrite modifications? [y/N] " confirm
            [[ "$confirm" =~ [yY] ]] || return 1
        fi
    fi

    # Confirm update
    if ! $auto_confirm; then
        read -p "Apply update? [y/N] " confirm
        [[ "$confirm" =~ [yY] ]] || return 1
    fi

    # Create backup
    local backup_dir="$CONFIG_DIR/backups/$(date +%Y%m%d-%H%M%S)-pre-update"
    mkdir -p "$backup_dir"
    cp "$CONFIG_DIR"/oh-my-opencode*.json "$backup_dir/" 2>/dev/null || true
    echo "✓ Backup created: $backup_dir"

    # Download and validate
    local temp_dir=$(mktemp -d)
    trap 'rm -rf "$temp_dir"' EXIT

    echo "Downloading remote configs..."
    if ! download_remote_configs "$temp_dir"; then
        echo "ERROR: Download failed" >&2
        return 1
    fi

    echo "Validating configs..."
    if ! validate_configs "$temp_dir"; then
        echo "ERROR: Validation failed" >&2
        return 1
    fi

    # Apply updates (preserve opencode.json)
    echo "Applying updates..."
    local files_updated=0
    for file in "$temp_dir"/*.json; do
        local basename=$(basename "$file")
        # Never overwrite opencode.json (user's API keys and settings)
        if [ "$basename" != "opencode.json" ]; then
            cp "$file" "$CONFIG_DIR/"
            files_updated=$((files_updated + 1))
        fi
    done

    # Re-symlink current mode
    rm -f "$CURRENT_CONFIG"
    ln -s "$CONFIG_DIR/oh-my-opencode-${current_mode}.json" "$CURRENT_CONFIG"

    store_config_hashes

    echo ""
    echo "✓ Update complete"
    echo "  Files updated: $files_updated"
    echo "  Current mode: $current_mode"
    echo "  Backup: $backup_dir"
    echo ""
    echo "Restart any running opencode sessions to apply the changes."
}

# Store SHA256 hashes of config files
store_config_hashes() {
    local hash_file="$CONFIG_DIR/.config-hashes"
    : > "$hash_file"  # Clear/create
    for config in "$CONFIG_DIR"/oh-my-opencode*.json; do
        if [ -f "$config" ]; then
            sha256sum "$config" >> "$hash_file"
        fi
    done
}

# Check if user has modified config files
has_user_modifications() {
    local hash_file="$CONFIG_DIR/.config-hashes"
    if [ ! -f "$hash_file" ]; then
        return 1  # No hash file, assume no modifications
    fi

    while read -r hash file; do
        if [ -f "$file" ]; then
            local current_hash=$(sha256sum "$file" | awk '{print $1}')
            if [ "$current_hash" != "$hash" ]; then
                return 0  # Modified
            fi
        fi
    done < "$hash_file"

    return 1  # No modifications
}

# Detect which config files have been modified
detect_modified_configs() {
    local hash_file="$CONFIG_DIR/.config-hashes"
    local modified=""

    if [ ! -f "$hash_file" ]; then
        return
    fi

    while read -r hash file; do
        if [ -f "$file" ]; then
            local current_hash=$(sha256sum "$file" | awk '{print $1}')
            if [ "$current_hash" != "$hash" ]; then
                modified="$modified $(basename "$file")"
            fi
        fi
    done < "$hash_file"

    echo "$modified"
}

# Main
case "${1:-}" in
    -h|--help|help)
        show_help
        exit 0
        ;;
    list|status)
        show_status
        exit 0
        ;;
    free|balanced|performance)
        switch_mode "$1"
        exit 0
        ;;
    "")
        show_status
        exit 0
        ;;
    check-update)
        check_update
        exit 0
        ;;
    update)
        perform_update "${2:-}"
        exit $?
        ;;
    *)
        echo "Error: Unknown command '$1'"
        echo ""
        show_help
        exit 1
        ;;
esac
