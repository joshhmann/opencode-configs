#!/bin/bash

# Oh My OpenCode Mode Switcher
# Usage: omo-mode [free|balanced|performance]

CONFIG_DIR="$HOME/.config/opencode"
CURRENT_CONFIG="$CONFIG_DIR/oh-my-opencode.json"

# Source version utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/lib/version-utils.sh" ]; then
    source "$SCRIPT_DIR/lib/version-utils.sh"
elif [ -f "$CONFIG_DIR/lib/version-utils.sh" ]; then
    source "$CONFIG_DIR/lib/version-utils.sh"
fi

show_help() {
    echo "Oh My OpenCode Mode Switcher"
    echo ""
    echo "Usage: omo-mode [MODE]"
    echo ""
    echo "Modes:"
    echo "  free        - Use free models primarily (opencode/kimi-k2.5-free, glm-4.7-free)"
    echo "  balanced    - Uses kimi-for-coding k2p5 via subscription, falls back to antigravity"
    echo "  performance - Maximum quality with kimi-for-coding k2p5 as primary"
    echo "  list        - Show available modes and current status"
    echo "  check-update - Check for available updates"
    echo ""
    echo "Examples:"
    echo "  omo-mode free       # Switch to free/frugal mode"
    echo "  omo-mode performance # Switch to performance mode"
}

show_status() {
    echo "Current Oh My OpenCode Mode:"
    echo ""
    
    if [ -L "$CURRENT_CONFIG" ]; then
        target=$(readlink "$CURRENT_CONFIG")
        mode=$(basename "$target" .json | sed 's/oh-my-opencode-//')
        echo "  Active: $mode mode"
        echo "  File:   $target"
    else
        echo "  Active: custom (not a symlink)"
        echo "  File:   $CURRENT_CONFIG"
    fi
    echo ""
    echo "Available modes:"
    for config in "$CONFIG_DIR"/oh-my-opencode*.json; do
        if [ -f "$config" ]; then
            name=$(basename "$config" .json | sed 's/oh-my-opencode-//')
            if [ "$name" = "oh-my-opencode" ]; then
                name="balanced (default)"
            fi
            echo "  - $name"
        fi
    done
}

switch_mode() {
    mode=$1
    
    case "$mode" in
        free)
            target="oh-my-opencode-free.json"
            ;;
        balanced)
            target="oh-my-opencode-balanced.json"
            # If balanced doesn't exist, we'll use the original
            if [ ! -f "$CONFIG_DIR/$target" ]; then
                echo "Creating balanced mode from current config..."
                cp "$CURRENT_CONFIG" "$CONFIG_DIR/oh-my-opencode-balanced.json"
                target="oh-my-opencode-balanced.json"
            fi
            ;;
        performance)
            target="oh-my-opencode-performance.json"
            ;;
        *)
            echo "Error: Unknown mode '$mode'"
            echo ""
            show_help
            exit 1
            ;;
    esac
    
    if [ ! -f "$CONFIG_DIR/$target" ]; then
        echo "Error: Configuration file not found: $CONFIG_DIR/$target"
        exit 1
    fi
    
    # Backup current config if it's not a symlink
    if [ -f "$CURRENT_CONFIG" ] && [ ! -L "$CURRENT_CONFIG" ]; then
        backup="$CONFIG_DIR/oh-my-opencode-backup-$(date +%Y%m%d-%H%M%S).json"
        cp "$CURRENT_CONFIG" "$backup"
        echo "Backed up current config to: $backup"
    fi
    
    # Remove existing symlink or file
    rm -f "$CURRENT_CONFIG"
    
    # Create new symlink
    ln -s "$CONFIG_DIR/$target" "$CURRENT_CONFIG"
    
    echo ""
    echo "âœ“ Switched to $mode mode"
    echo "  Config: $CONFIG_DIR/$target"
    echo ""
    echo "Next time you start opencode, it will use the $mode configuration."
    echo "Restart any running opencode sessions to apply the changes."
}

check_update() {
    echo "Current Oh My OpenCode Mode:"
    echo ""
    
    # Get current mode from symlink
    local current_mode="unknown"
    local local_version="unknown"
    if [ -L "$CURRENT_CONFIG" ]; then
        local target=$(readlink "$CURRENT_CONFIG")
        current_mode=$(basename "$target" .json | sed 's/oh-my-opencode-//')
        if [ -f "$target" ] && command -v get_config_version &> /dev/null; then
            local_version=$(get_config_version "$target")
        fi
    fi
    
    echo "  Active: $current_mode"
    echo "  Local version: $local_version"
    
    # Get remote version
    local remote_version="unknown"
    local base_url="https://raw.githubusercontent.com/joshhmann/opencode-configs/main/configs"
    local temp_file=$(mktemp)
    
    if curl -fsSL -m 10 "$base_url/oh-my-opencode-${current_mode}.json" -o "$temp_file" 2>/dev/null; then
        if command -v get_config_version &> /dev/null; then
            remote_version=$(get_config_version "$temp_file")
        fi
    fi
    rm -f "$temp_file"
    
    echo "  Remote version: $remote_version"
    
    # Compare versions
    if [ "$local_version" != "unknown" ] && [ "$remote_version" != "unknown" ]; then
        if command -v version_compare &> /dev/null; then
            version_compare "$local_version" "$remote_version"
            case $? in
                0) echo "  Status: Up to date" ;;
                1) echo "  Status: Local is newer (development?)" ;;
                2) echo "  Status: Update available" ;;
            esac
        else
            if [ "$local_version" = "$remote_version" ]; then
                echo "  Status: Up to date"
            else
                echo "  Status: Version mismatch (local: $local_version, remote: $remote_version)"
            fi
        fi
    else
        echo "  Status: Could not determine update status"
    fi
}

# Download remote configs to temp directory
download_remote_configs() {
    local temp_dir="$1"
    local base_url="https://raw.githubusercontent.com/joshhmann/opencode-configs/main/configs"
    local configs="oh-my-opencode-free.json oh-my-opencode-balanced.json oh-my-opencode-performance.json oh-my-opencode-gemini-free.json oh-my-opencode-gemini-balanced.json oh-my-opencode-gemini-performance.json"

    for config in $configs; do
        if ! curl -fsSL -m 30 "$base_url/$config" -o "$temp_dir/$config" 2>/dev/null; then
            echo "ERROR: Failed to download $config" >&2
            return 1
        fi
    done
    return 0
}

# Validate downloaded configs
validate_configs() {
    local temp_dir="$1"
    local has_error=0

    for config in "$temp_dir"/*.json; do
        if [ -f "$config" ]; then
            local basename=$(basename "$config")

            # Validate JSON syntax
            if ! python3 -c "import json; json.load(open('$config'))" 2>/dev/null; then
                echo "ERROR: Invalid JSON in $basename" >&2
                has_error=1
                continue
            fi

            # Verify _version field exists
            if ! grep -q '"_version"' "$config"; then
                echo "ERROR: Missing _version in $basename" >&2
                has_error=1
                continue
            fi
        fi
    done

    return $has_error
}

# Main
case "${1:-}" in
    -h|--help|help)
        show_help
        exit 0
        ;;
    list|status)
        show_status
        exit 0
        ;;
    free|balanced|performance)
        switch_mode "$1"
        exit 0
        ;;
    "")
        show_status
        exit 0
        ;;
    check-update)
        check_update
        exit 0
        ;;
    *)
        echo "Error: Unknown command '$1'"
        echo ""
        show_help
        exit 1
        ;;
esac
